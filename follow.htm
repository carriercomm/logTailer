<html>
<head>
<title>Log Tailer</title>
<style>

.screen {
	height: 400px;
	background-color: black;
	padding: 4px;
	overflow: auto;
}

.screen div {
	padding: 0;
	margin: 0;
	border: 0;
	background-color: black;
	color: #bbb;
	line-height: 1.2;
	white-space: pre-wrap;
	xfont-size: 20px;
	font-family: monospace;
}

</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
</head>
<body>

<div id="screens"></div>

<script>

function log_handler(url, parent){

	var self = this;

	this.url = url;
	this.parent = parent;
	this.screen = $('<div class="screen"></div>').appendTo(parent);
	this.screen.html('<div></div>');

	this.lx = 1;
	this.lines = {};
	this.line_keys = [];
	this.max_lines = 50;
	this.idx = 0;

	this.addLine = function(line, repaint){

		var id = self.lx++;

		self.line_keys.push(id);
		self.lines[id] = $('<div/>').text(line).html();

		if (self.line_keys.length > self.max_lines){
			var dkey = self.line_keys.shift();
			delete self.lines[dkey];
		}

		if (repaint) self.repaint();

		return id;
	};

	this.repaint = function(){

		var buffer = "";
		var l = self.line_keys.length;

		for (var i=0; i<l; i++){
			buffer += self.lines[self.line_keys[i]] + "\n";
		}

		self.screen.find('div').html(buffer);
		self.screen.scrollTop(self.screen[0].scrollHeight);
	};

	this.onLoaded = function(o, success, req){

		if (!o){
			if (!req.status){
				self.addLine('[ERROR] Can\'t connect to log server', 1);
			}else{
				self.addLine('[ERROR] Error from log server: '+req.status, 1);
			}
			return;
		}

		if (!o.ok){
			self.addLine(o.error);
			return;
		}

		if (o.lines){
			for (var i=0; i<o.lines.length; i++){
				self.addLine(o.lines[i]);
			}
			self.repaint();
		}

		if (o.l){
			self.idx = o.l;
		}

		window.setTimeout(function(){ self.pumpLog(); }, 0);
	};

	this.onError = function(x){

		// TODO
		console.log('ERROR', x);
	};

	this.pumpLog = function(){

		$.ajax({
			url: self.url+'?l='+self.idx,
			success: this.onLoaded,
			error: this.onError,
			dataType: 'json',
		});
	};

	this.repaint();
	this.pumpLog();
}

var logs = {
	'neuron3-messages' : 'http://neuron3.iamcal.com:8124/',
};

for (var i in logs){

	// create the HTML screen

	$('<h2></h2>').text(i).appendTo('#screens');
	new log_handler(logs[i], $('#screens'));
}

</script>

</body>
</html>
